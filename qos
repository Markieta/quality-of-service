#!/usr/bin/env bash

function pause()
{
    /usr/bin/transmission-remote 9091 -as --alt-speed > /dev/null
}

function resume()
{
    /usr/bin/transmission-remote 9091 -AS --no-alt-speed > /dev/null
}

function start()
{
    on=false
    pause

    declare -a ignored=(
        192.168.0.1
        192.168.0.2
        192.168.0.50
        192.168.0.51
        192.168.0.52
        192.168.0.53
        192.168.0.54
    )

    while true; do
        hostsUp=false

        hosts=$(/usr/bin/nmap -sP 192.168.0.* > /dev/null 2>&1; arp -an | grep -v 'incomplete' | cut -d "(" -f2 | cut -d ")" -f1)

        if [ ! -z "$(echo ${ignored[@]} ${ignored[@]} ${hosts[@]} | tr ' ' '\n' | sort | uniq -u)" ]; then
            hostsUp=true
        fi

        if [ "$hostsUp" = true ] ||
           [ "$(/usr/bin/wget -q --user admin --password admin 192.168.0.50/PI_FXS_1_Stats.xml -O - | /usr/bin/xmllint --xpath "string(//model/object/parameter/value/@current)" - )" = "Off Hook" ] ||
           [ "$(/usr/bin/curl --data-binary '{ "jsonrpc": "2.0", "method": "XBMC.GetInfoBooleans", "params": { "booleans": ["System.IdleTime(599) "]}, "id": 1}' -H 'content-type: application/json;' http://kodi@localhost:8080/jsonrpc | jq .result[])" = false ]; then
            if [ "$on" = true ]; then
                pause
                on=false
            fi
            sleep 600
        else
            sleep 5

            if [ "$on" = false ]; then
                on=true
                resume
            fi
        fi
    done
}

function stop()
{
    pause
    kill -s HUP $MAINPID
}

function restart()
{
    stop
    start
}

case "$1" in
    start|stop|restart|pause|resume) "$1" ;;
    *) echo $"Usage: $0 {start|stop|restart|pause|resume}"
esac
